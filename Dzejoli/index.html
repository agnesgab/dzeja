<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="sass_style.css" />

    <script
      src="https://kit.fontawesome.com/4c14822e5a.js"
      crossorigin="anonymous"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <title>Dzejoļu meklētājs</title>
  </head>

  <body>
    <header>
      <h1>Meklētājs</h1>
    </header>
    <div class="poem-wrapper">
      <div class="search-wrapper">
        <div class="search-cards-div">
          <div class="theme-card" id="b-day">
            <p>Dzimšanas diena+</p>
          </div>
          <div class="theme-card" id="n-day">
            <p>Vārda diena+</p>
          </div>
          <div class="theme-card" id="grad">
            <p>Ziemassvētki+</p>
          </div>
          <div class="theme-card" id="woman">
            <p>Sieviete+</p>
          </div>
          <div class="theme-card" id="love">
            <p>Mīlestība+</p>
          </div>
          <div class="theme-card" id="n-year">
            <p>Jaunais gads</p>
          </div>
          <div class="theme-card" id="man">
            <p>Vīrietis+</p>
          </div>
          <div class="theme-card" id="easter">
            <p>Lieldienas</p>
          </div>
          <div class="theme-card" id="">
            <p>Kaut kas</p>
          </div>
          <div class="theme-card" id="">
            <p>Latvija</p>
          </div>
          <div class="theme-card" id="">
            <p>Ceļavārdi+</p>
          </div>
          <div class="theme-card" id="">
            <p>Kāzas+</p>
          </div>
          <div class="theme-card" id="">
            <p>Cits</p>
          </div>
        </div>
      </div>

      <div class="results-wrapper" id="results">
        <div class="poem-card">
          <h3 class="name"></h3>
          <p class="poem"></p>
          <p class="author"></p>
          <button class="heart-btn"><i class="far fa-heart"> Patīk</i></button>
        </div>
      </div>

      <div class="saved-container display-none">
        <div class="btn-div">
          <button id="open-btn">Atvērt</button>
        </div>

        <div class="saved-poem-wrapper">
          <div class="saved-poem-div">
            <p class="saved-p">teksts teksts</p>
            <button id="remove-btn"><i class="fas fa-times"></i></button>
          </div>
          <div class="saved-poem-div">
            <p class="saved-p">
              teksts teksts Lorem ipsum dolor sit amet consectetur adipisicing
              elit. Quaerat, quibusdam.
            </p>
            <button id="remove-btn"><i class="fas fa-times"></i></button>
          </div>
          <div class="saved-poem-div">
            <p class="saved-p">
              teksts teksts Lorem ipsum dolor sit amet consectetur adipisicing
              elit. Provident totam fugit qui, similique veritatis delectus aut
              dolores distinctio est cum!
            </p>
            <button id="remove-btn"><i class="fas fa-times"></i></button>
          </div>
          <div class="saved-poem-div">
            <p class="saved-p">teksts teksts</p>
            <button id="remove-btn"><i class="fas fa-times"></i></button>
          </div>
          <div class="saved-poem-div">
            <p class="saved-p">teksts teksts Lorem ipsum dolor sit amet.</p>
            <button id="remove-btn"><i class="fas fa-times"></i></button>
          </div>
        </div>
      </div>
      <div class="print-back-btn display-none">
        <button id="back-btn">Atpakaļ</button>
        <button id="print-btn">Printēt</button>
      </div>
    </div>

    <script>
      //let a = {};
      let savedPoems = []; //šeit iepušot a
      const resultsDiv = document.getElementById("results");
      resultsDiv.classList.add("display-none");

      const cards = document.querySelectorAll(".search-cards-div .theme-card");
      let likeBtn = document.querySelector(".heart-btn");
      const savedContainer = document.querySelector(".saved-container");
      const removeBtns = document.querySelectorAll(
        ".saved-poem-div #remove-btn"
      );
      const openBtn = document.querySelector(".saved-container #open-btn");
      const wrap = document.querySelector(".saved-poem-wrapper");
      const searchDiv = document.querySelector(".search-wrapper");
      const printBackBtns = document.querySelector(".print-back-btn");
      printBackBtns.classList.add("display-none");

      //Fetch
      const searchPoems = async (searchText) => {
        const response = await fetch("dati.json");
        const poems = await response.json();

        //console.log(poems);

        //Meklēt/filtrēt JSON datus
        let matches = poems.filter((poem) => {
          resultsDiv.classList.remove("display-none");
          const regex = new RegExp(`${searchText}`, "gi");
          return poem.tēma.match(regex);

          //poem.nosaukums.match(regex) || poem.teksts.match(regex) || poem.autors.match(regex) ||
        });
        if (searchText.length === 0) {
          matches = [];
          resultsDiv.innerHTML = "";
        }

        showPoems(matches);
      };

      //Attēlot izfiltrēto HTML
      const showPoems = (matches) => {
        if (matches.length > 0) {
          console.log(matches);
          let sorted = matches.sort((a, b) => {
            return b.id - a.id;
          });
          console.log(sorted, "sorted");

          const html = matches
            .map(
              (match) =>
                `

            <div class="poem-card line">
              <h3 class="name" >${match.nosaukums}</h3>
              <p class="poem">${match.teksts}</p>
              <p class="author">${match.autors}</p>
              <div class="btn-cont">
                <button class="heart-btn" onclick='saveText("${match.teksts}", "${match.autors}")'><i class="far fa-heart"> Patīk</i></button>
              </div>
            </div>
          `
            )
            .join("");

          resultsDiv.innerHTML = html;
        } else {
          resultsDiv.innerHTML = "Nekas netika atrasts";
        }
      };

      //Izvēlētie dzejoļi redzami atsevišķā sadaļā
      function saveText(poemText, poemAuthor) {
        savedContainer.classList.remove("display-none");
        let savedParag = document.querySelectorAll(".saved-p");
        let savedWrap = document.querySelector(".saved-poem-div");

        //Vēlamais:
        //Katrs izvēlētais dzejolis sagalabājas atsevišķā rāmītī(savedParag), iekš savedWrap
        //Katram rāmītim pievienojas poga "X", ar kuru pievienoto var dzēst
        savedPoems.push(poemText, poemAuthor);
        savedWrap.innerHTML = savedPoems;
        //Esošais:
        //Visi dzejoļi saglabājas vienā rāmītī
        //Pogas nav
      }

      function openSavedPoems() {
        let dispNone = [resultsDiv, searchDiv, openBtn];
        dispNone.forEach((d) => d.classList.add("display-none"));

        savedContainer.classList.remove("saved-container");
        savedContainer.classList.add("test");

        const newResults = document
          .querySelectorAll(".saved-poem-div")
          .forEach((res) => {
            res.classList.remove("saved-poem-div");
            res.classList.add("new-results");
          });

        wrap.classList.add("new");

        //parādās poga "PRINTĒT" un "ATPAKAĻ"
        printBackBtns.classList.remove("display-none");
      }

      Array.from(cards).forEach((card) => {
        card.addEventListener("click", (e) => {
          Array.from(cards).forEach((c) => {
            c.classList.remove("clicked");
          });

          card.classList.add("clicked");

          const clickedCard = e.target;

          searchPoems(clickedCard.textContent);
        });
      });

      likeBtn.addEventListener("click", saveText);

      Array.from(removeBtns).forEach((btn) => {
        btn.addEventListener("click", (e) => {
          const sPoemDiv = e.target.parentElement.parentElement;
          sPoemDiv.parentNode.removeChild(sPoemDiv);
        });
      });

      openBtn.addEventListener("click", openSavedPoems);

      const returnBtn = document
        .querySelector("#back-btn")
        .addEventListener("click", () => {
          let display = [resultsDiv, searchDiv, openBtn, printBackBtns];
          display.forEach((d) => d.classList.remove("display-none"));

          const newResults = document
            .querySelectorAll(".saved-poem-div")
            .forEach((res) => {
              res.classList.add("saved-poem-div");
            });

          savedContainer.classList.add("saved-container");

          wrap.classList.remove("new");

          printBackBtns.classList.add("display-none");
        });

      const printBtn = document
        .querySelector("#print-btn")
        .addEventListener("click", () => {
          window.print();
        });
    </script>
  </body>
</html>
